<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Control Center | Dakshayani Enterprises</title>
  <meta
    name="description"
    content="Tabbed administrator workspace for onboarding approvals, access control, AI settings, complaints, and operational monitoring."
  />
  <link rel="icon" href="images/favicon.ico" />
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>
<body data-dashboard-theme="light">
  <main class="dashboard">
    <div class="container dashboard-shell">
      <div class="dashboard-auth-bar" role="banner">
        <div class="dashboard-auth-user">
          <i class="fa-solid fa-user-shield" aria-hidden="true"></i>
          <div>
            <small>Signed in as</small>
            <strong>System Administrator</strong>
          </div>
        </div>
        <div class="dashboard-auth-actions">
          <button type="button" class="btn btn-ghost" data-open-quick-search>
            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
            Quick search
          </button>
          <div class="dashboard-theme-toggle" role="group" aria-label="Theme selection">
            <label>
              <input type="radio" name="theme" value="light" data-theme-option checked />
              <span>Light</span>
            </label>
            <label>
              <input type="radio" name="theme" value="dark" data-theme-option />
              <span>Dark</span>
            </label>
            <label>
              <input type="radio" name="theme" value="auto" data-theme-option />
              <span>Auto</span>
            </label>
          </div>
          <a href="login.html" class="btn btn-ghost">
            <i class="fa-solid fa-arrow-right-from-bracket" aria-hidden="true"></i>
            Log out
          </a>
        </div>
      </div>

      <header class="dashboard-header">
        <div class="dashboard-heading">
          <span class="badge badge-soft"><i class="fa-solid fa-lock"></i> Secure oversight</span>
          <h1>Admin Control Center</h1>
          <p class="dashboard-subheading">
            Approve new users, orchestrate services, and monitor subsidy, AMC, and complaints without leaving this workspace.
          </p>
          <p class="dashboard-meta">
            <i class="fa-regular fa-circle-check" aria-hidden="true"></i>
            Backup verified <strong>--</strong> · <span>Lockout enforced after 5 failed login attempts</span>
          </p>
        </div>
        <div class="dashboard-search" role="search">
          <form class="dashboard-search-field" data-dashboard-search>
            <label for="dashboard-search-input" class="sr-only">Search admin records</label>
            <input
              id="dashboard-search-input"
              type="search"
              placeholder="Search users, tickets, installers…"
              autocomplete="off"
              aria-describedby="dashboard-search-help"
            />
            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          </form>
          <p id="dashboard-search-help" class="dashboard-subheading">
            Instant lookup across onboarding queues, customers, AMC renewals, and subsidy pipeline.
          </p>
          <div class="dashboard-search-results" data-dashboard-search-results hidden>
            <p class="dashboard-search-empty">Start typing to surface admin modules, records, and recent activity.</p>
          </div>
        </div>
      </header>

      <div class="dashboard-body">
        <nav class="dashboard-nav" aria-label="Admin navigation" role="tablist">
          <p class="dashboard-nav-title">Workspace</p>
          <ul>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="true" data-tab-target="overview">
                <i class="fa-solid fa-chart-line"></i> Overview
              </button>
            </li>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="false" data-tab-target="onboarding">
                <i class="fa-solid fa-user-plus"></i> Onboarding &amp; Approvals
              </button>
            </li>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="false" data-tab-target="access">
                <i class="fa-solid fa-fingerprint"></i> Access Control
              </button>
            </li>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="false" data-tab-target="health">
                <i class="fa-solid fa-heart-pulse"></i> System Health
              </button>
            </li>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="false" data-tab-target="ai">
                <i class="fa-solid fa-robot"></i> Gemini AI Provider
              </button>
            </li>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="false" data-tab-target="complaints">
                <i class="fa-solid fa-headset"></i> Complaints &amp; Service
              </button>
            </li>
            <li>
              <button class="dashboard-nav-link" type="button" role="tab" aria-selected="false" data-tab-target="audit">
                <i class="fa-solid fa-shield-halved"></i> Audit &amp; Data Logs
              </button>
            </li>
          </ul>
          <div class="dashboard-nav-footer">
            <a class="dashboard-nav-link dashboard-nav-link--logout" href="login.html">
              <i class="fa-solid fa-door-open"></i> Sign out
            </a>
          </div>
        </nav>

        <div class="dashboard-main">
          <section class="dashboard-section" id="overview" role="tabpanel" data-tab-panel>
            <h2>Operational overview</h2>
            <p class="dashboard-section-sub">Real-time KPIs from leads, customers, service tickets, AMC and subsidy queues.</p>
            <div class="dashboard-cards">
              <article class="dashboard-card dashboard-card--neutral">
                <div class="dashboard-card-icon" aria-hidden="true"><i class="fa-solid fa-solar-panel"></i></div>
                <div>
                  <p class="dashboard-card-title">Active customers</p>
                  <p class="dashboard-card-value" data-metric="customers">--</p>
                  <p class="dashboard-card-meta">Counts update automatically when new customer logins are activated.</p>
                </div>
              </article>
              <article class="dashboard-card dashboard-card--positive">
                <div class="dashboard-card-icon" aria-hidden="true"><i class="fa-solid fa-user-gear"></i></div>
                <div>
                  <p class="dashboard-card-title">New user requests</p>
                  <p class="dashboard-card-value" data-metric="approvals">--</p>
                  <p class="dashboard-card-meta">Pending invitations awaiting admin approval.</p>
                </div>
              </article>
              <article class="dashboard-card dashboard-card--warning">
                <div class="dashboard-card-icon" aria-hidden="true"><i class="fa-solid fa-ticket"></i></div>
                <div>
                  <p class="dashboard-card-title">Open service tickets</p>
                  <p class="dashboard-card-value" data-metric="tickets">--</p>
                  <p class="dashboard-card-meta">Ticket volume updates after service data refresh.</p>
                </div>
              </article>
              <article class="dashboard-card">
                <div class="dashboard-card-icon" aria-hidden="true"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                <div>
                  <p class="dashboard-card-title">Subsidy pipeline</p>
                  <p class="dashboard-card-value" data-metric="subsidy">--</p>
                  <p class="dashboard-card-meta">Financial progress appears when subsidy data loads.</p>
                </div>
              </article>
            </div>
          </section>

          <section class="dashboard-section" id="onboarding" role="tabpanel" data-tab-panel hidden>
            <h2>Onboarding &amp; approvals</h2>
            <p class="dashboard-section-sub">
              Admins can directly create login credentials for any role. Employee-invited accounts remain pending until you approve
              and assign permissions.
            </p>
            <div class="dashboard-profile-grid">
              <form class="dashboard-form" data-admin-user-form>
                <h3>Create user account</h3>
                <div class="dashboard-form-grid dashboard-form-grid--two">
                  <label>
                    Full name
                    <input type="text" name="fullName" placeholder="Rohan Sharma" required />
                  </label>
                  <label>
                    Email address
                    <input type="email" name="email" placeholder="name@example.com" required />
                  </label>
                  <label>
                    Username
                    <input type="text" name="username" placeholder="rohan.sharma" minlength="3" required />
                  </label>
                  <label>
                    Temporary password
                    <input type="password" name="password" placeholder="Generate secure password" minlength="6" required />
                  </label>
                  <label>
                    Role
                    <select name="role" required>
                      <option value="Employee">Employee</option>
                      <option value="Installer">Installer</option>
                      <option value="Referrer">Referrer</option>
                      <option value="Customer">Customer</option>
                    </select>
                  </label>
                  <label>
                    Permissions note
                    <input type="text" name="permissions" placeholder="e.g. View solar proposals" />
                  </label>
                </div>
                <p class="dashboard-form-note">
                  <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                  Credentials are stored securely and can be reset anytime from the user roster.
                </p>
                <div>
                  <button type="submit" class="btn btn-secondary">Create user</button>
                  <button type="reset" class="btn btn-ghost">Clear</button>
                </div>
              </form>

              <section class="dashboard-form dashboard-form--list">
                <h3>Pending employee invitations</h3>
                <ul class="dashboard-list" data-pending-list>
                  <li class="dashboard-list-empty">
                    <p class="primary">No pending invitations logged.</p>
                    <p class="secondary">Employee-submitted profiles will appear here for your approval.</p>
                  </li>
                </ul>
                <form class="dashboard-inline-form" data-invite-form>
                  <h4>Record new invitation</h4>
                  <div class="dashboard-inline-fields">
                    <label>
                      Name
                      <input type="text" name="name" placeholder="Amit Verma" required />
                    </label>
                    <label>
                      Email
                      <input type="email" name="email" placeholder="amit@example.com" required />
                    </label>
                    <label>
                      Role requested
                      <select name="role" required>
                        <option value="Employee">Employee</option>
                        <option value="Installer">Installer</option>
                        <option value="Referrer">Referrer</option>
                        <option value="Customer">Customer</option>
                      </select>
                    </label>
                    <label>
                      Submitted by employee
                      <input type="text" name="submittedBy" placeholder="Priya" required />
                    </label>
                  </div>
                  <button type="submit" class="btn btn-secondary btn-sm">Log invitation</button>
                </form>
              </section>
            </div>

            <section class="dashboard-form dashboard-form--table">
              <h3>All platform users</h3>
              <div class="dashboard-table-toolbar">
                <label class="dashboard-filter">
                  Filter by role
                  <select data-user-filter>
                    <option value="all">All roles</option>
                    <option value="Admin">Admin</option>
                    <option value="Employee">Employee</option>
                    <option value="Installer">Installer</option>
                    <option value="Referrer">Referrer</option>
                    <option value="Customer">Customer</option>
                  </select>
                </label>
                <span class="dashboard-table-meta" data-user-count>0 users</span>
              </div>
              <div class="dashboard-table-wrapper" role="region" aria-live="polite">
                <table class="dashboard-table">
                  <thead>
                    <tr>
                      <th scope="col">Name</th>
                      <th scope="col">Role</th>
                      <th scope="col">Username</th>
                      <th scope="col">Status</th>
                      <th scope="col">Credentials</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody data-user-table-body>
                    <tr class="dashboard-empty-row">
                      <td colspan="6">No users created yet.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          </section>

          <section class="dashboard-section" id="access" role="tabpanel" data-tab-panel hidden>
            <h2>Login &amp; access control</h2>
            <p class="dashboard-section-sub">
              Configure retry limits, lockout policies, and monitor access assignments across every portal role.
            </p>
            <div class="dashboard-profile-grid">
              <form class="dashboard-form" data-login-policy>
                <h3>Authentication controls</h3>
                <div class="dashboard-form-grid dashboard-form-grid--two">
                  <label>
                    Maximum retry attempts
                    <input type="number" name="retry" value="5" min="3" max="10" />
                  </label>
                  <label>
                    Lockout duration (minutes)
                    <input type="number" name="lockout" value="30" min="5" max="120" />
                  </label>
                  <label>
                    2FA enforcement
                    <select name="twofactor">
                      <option value="all" selected>All roles (recommended)</option>
                      <option value="admin">Admin only</option>
                      <option value="none">Disabled</option>
                    </select>
                  </label>
                  <label>
                    Default session timeout (minutes)
                    <input type="number" name="session" value="45" min="15" max="240" />
                  </label>
                </div>
                <p class="dashboard-form-note">
                  <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                  CSRF tokens rotate every login · Email OTP fallback auto-enforced for administrators.
                </p>
                <div>
                  <button type="submit" class="btn btn-secondary">Save policies</button>
                  <button type="reset" class="btn btn-ghost">Reset</button>
                </div>
              </form>

              <section class="dashboard-form dashboard-form--list">
                <h3>Role assignments snapshot</h3>
                <ul class="dashboard-list" data-role-assignment-list>
                  <li class="dashboard-list-empty">
                    <p class="primary">No active users recorded.</p>
                    <p class="secondary">Create users or approve invitations to populate this summary.</p>
                  </li>
                </ul>
                <p class="dashboard-form-note">
                  <i class="fa-solid fa-shield-check" aria-hidden="true"></i>
                  Review the user roster to deactivate dormant accounts or adjust permissions.
                </p>
              </section>
            </div>
          </section>

          <section class="dashboard-section" id="health" role="tabpanel" data-tab-panel hidden>
            <h2>System health</h2>
            <p class="dashboard-section-sub">Monitor uptime, SLA breaches, and exportable audit trails for every user action.</p>
            <div class="dashboard-profile-grid">
              <article class="dashboard-form">
                <h3>Health summary</h3>
                <div class="dashboard-form-grid dashboard-form-grid--two">
                  <label>
                    Uptime (7 days)
                    <input type="text" value="--" readonly aria-label="Uptime awaiting data" />
                  </label>
                  <label>
                    Error logs (24h)
                    <input type="text" value="--" readonly aria-label="Error logs awaiting data" />
                  </label>
                  <label>
                    Last backup
                    <input type="text" value="--" readonly aria-label="Backup status awaiting data" />
                  </label>
                  <label>
                    Storage utilisation
                    <input type="text" value="--" readonly aria-label="Storage utilisation awaiting data" />
                  </label>
                </div>
                <p class="dashboard-form-note">
                  <i class="fa-solid fa-database" aria-hidden="true"></i>
                  Schedule exports for detailed activity, error, and notification logs.
                </p>
                <div>
                  <button type="button" class="btn btn-secondary" data-action="export-logs">
                    <i class="fa-solid fa-file-export"></i>
                    Export logs
                  </button>
                  <button type="button" class="btn btn-ghost" data-action="view-monitoring">View monitoring</button>
                </div>
              </article>

              <article class="dashboard-form">
                <h3>Recent activity feed</h3>
                <ul class="dashboard-notifications" data-placeholder="activity-feed">
                  <li class="dashboard-notification dashboard-notification--info">
                    <i class="fa-solid fa-bolt" aria-hidden="true"></i>
                    <div>
                      <p>No recent activity to display.</p>
                      <span>Live audit events will appear after integration.</span>
                    </div>
                  </li>
                </ul>
              </article>
            </div>
          </section>

          <section class="dashboard-section" id="ai" role="tabpanel" data-tab-panel hidden>
            <h2>Gemini AI provider settings</h2>
            <p class="dashboard-section-sub">
              Manage secure API keys and model codes for text, image, and TTS interactions used across internal copilots.
            </p>
            <form class="dashboard-form" data-gemini-form>
              <h3>API credentials</h3>
              <div class="dashboard-form-grid dashboard-form-grid--two">
                <label>
                  Gemini API key
                  <input
                    type="password"
                    name="apiKey"
                    value="AIzaSyAsCEn7cd9vZlb5M5z9kw3XwbGkOjg8md0"
                    placeholder="Enter secure API key"
                    autocomplete="off"
                    required
                  />
                </label>
                <label>
                  Text model code
                  <input type="text" name="textModel" value="gemini-2.5-flash" required />
                </label>
                <label>
                  Image model code
                  <input type="text" name="imageModel" value="gemini-2.5-flash-image" required />
                </label>
                <label>
                  TTS model code
                  <input type="text" name="ttsModel" value="gemini-2.5-flash-preview-tts" required />
                </label>
              </div>
              <p class="dashboard-form-note">
                <i class="fa-solid fa-shield" aria-hidden="true"></i>
                API keys stay masked · Rotate quarterly or immediately after any suspected compromise.
              </p>
              <div>
                <button type="submit" class="btn btn-secondary" data-action="save-gemini">Save settings</button>
                <button type="button" class="btn btn-ghost" data-action="reset-gemini">Reset defaults</button>
                <button type="button" class="btn btn-tertiary" data-action="test-gemini">
                  <i class="fa-solid fa-plug-circle-check" aria-hidden="true"></i>
                  Test connection
                </button>
              </div>
            </form>
          </section>

          <section class="dashboard-section" id="complaints" role="tabpanel" data-tab-panel hidden>
            <h2>Complaints &amp; service management</h2>
            <p class="dashboard-section-sub">
              Track the complaint lifecycle from intake through resolution, assign owners, and monitor SLA deadlines.
            </p>
            <div class="dashboard-profile-grid">
              <article class="dashboard-form">
                <h3>Complaint pipeline</h3>
                <div class="dashboard-lists">
                  <div class="dashboard-list">
                    <header>
                      <i class="fa-solid fa-inbox" aria-hidden="true"></i>
                      <h3>Intake</h3>
                    </header>
                    <ul>
                      <li>
                        <p class="primary" data-placeholder="complaint-intake">No complaints loaded.</p>
                        <p class="secondary">Website and internal submissions appear here for triage.</p>
                      </li>
                    </ul>
                  </div>
                  <div class="dashboard-list">
                    <header>
                      <i class="fa-solid fa-stethoscope" aria-hidden="true"></i>
                      <h3>Triage</h3>
                    </header>
                    <ul>
                      <li>
                        <p class="primary" data-placeholder="complaint-triage">No triage items available.</p>
                        <p class="secondary">Prioritized complaints appear after admin review.</p>
                      </li>
                    </ul>
                  </div>
                  <div class="dashboard-list">
                    <header>
                      <i class="fa-solid fa-screwdriver-wrench" aria-hidden="true"></i>
                      <h3>Work</h3>
                    </header>
                    <ul>
                      <li>
                        <p class="primary" data-placeholder="complaint-work">Work queue empty.</p>
                        <p class="secondary">Assigned employees will track SLA progress from this view.</p>
                      </li>
                    </ul>
                  </div>
                  <div class="dashboard-list">
                    <header>
                      <i class="fa-solid fa-circle-check" aria-hidden="true"></i>
                      <h3>Resolution</h3>
                    </header>
                    <ul>
                      <li>
                        <p class="primary" data-placeholder="complaint-resolution">No recent resolutions available.</p>
                        <p class="secondary">Closed complaints show here after customer confirmation.</p>
                      </li>
                    </ul>
                  </div>
                </div>
              </article>

              <article class="dashboard-form">
                <h3>SLA reminders</h3>
                <ul class="dashboard-reminders" data-placeholder="sla-reminders">
                  <li>
                    <p>No reminders configured.</p>
                    <span>Schedule AMC or maintenance follow-ups from the service module.</span>
                  </li>
                </ul>
              </article>
            </div>
          </section>

          <section class="dashboard-section" id="audit" role="tabpanel" data-tab-panel hidden>
            <h2>Audit &amp; data logs</h2>
            <p class="dashboard-section-sub">
              Review exported reports, data deletion requests, and regulator-ready audit evidence.
            </p>
            <div class="dashboard-profile-grid">
              <article class="dashboard-form dashboard-form--list">
                <h3>Data governance queue</h3>
                <ul class="dashboard-list">
                  <li>
                    <p class="primary">No pending deletion or export requests.</p>
                    <p class="secondary">Approved records will surface here once logged by support teams.</p>
                  </li>
                </ul>
              </article>
              <article class="dashboard-form">
                <h3>Reference resources</h3>
                <div class="dashboard-reference">
                  <a href="deletion-report.md" class="dashboard-reference-link">
                    <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                    <span>
                      <strong>Deletion register</strong>
                      <small>Recent data erasure activity &amp; compliance notes</small>
                    </span>
                    <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                  </a>
                  <a href="policies.html" class="dashboard-reference-link">
                    <i class="fa-solid fa-scale-balanced" aria-hidden="true"></i>
                    <span>
                      <strong>Security policies</strong>
                      <small>Review retention, access, and audit standards</small>
                    </span>
                    <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                  </a>
                </div>
              </article>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>

  <div class="dashboard-toast-container" aria-live="polite" aria-atomic="false" data-toast-container></div>

  <template id="dashboard-search-result-template">
    <div class="dashboard-search-group">
      <h3></h3>
      <ul></ul>
    </div>
  </template>

  <template id="dashboard-search-item-template">
    <li>
      <p class="title"></p>
      <p class="desc"></p>
    </li>
  </template>

  <template id="dashboard-toast-template">
    <div class="dashboard-toast" role="status" data-toast>
      <strong class="dashboard-toast-title"></strong>
      <span class="dashboard-toast-message"></span>
    </div>
  </template>

  <script>
    (function () {
      'use strict';

      const THEME_STORAGE_KEY = 'dakshayani-admin-theme';
      const USER_STORAGE_KEY = 'dakshayani-admin-users';
      const PENDING_STORAGE_KEY = 'dakshayani-admin-pending';
      const GEMINI_STORAGE_KEY = 'dakshayani-gemini-settings';
      const DEFAULT_GEMINI_KEY = 'AIzaSyAsCEn7cd9vZlb5M5z9kw3XwbGkOjg8md0';

      const toastContainer = document.querySelector('[data-toast-container]');
      const toastTemplate = document.getElementById('dashboard-toast-template');
      const searchResultTemplate = document.getElementById('dashboard-search-result-template');
      const searchItemTemplate = document.getElementById('dashboard-search-item-template');
      const searchForm = document.querySelector('[data-dashboard-search]');
      const searchInput = document.getElementById('dashboard-search-input');
      const searchResultsHost = document.querySelector('[data-dashboard-search-results]');
      const themeOptions = Array.from(document.querySelectorAll('[data-theme-option]'));
      const quickSearchButton = document.querySelector('[data-open-quick-search]');
      const navButtons = Array.from(document.querySelectorAll('[data-tab-target]'));
      const tabPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));

      const metrics = {
        customers: document.querySelector('[data-metric="customers"]'),
        approvals: document.querySelector('[data-metric="approvals"]'),
      };

      const userTableBody = document.querySelector('[data-user-table-body]');
      const userCountLabel = document.querySelector('[data-user-count]');
      const userFilterSelect = document.querySelector('[data-user-filter]');
      const pendingList = document.querySelector('[data-pending-list]');
      const inviteForm = document.querySelector('[data-invite-form]');
      const createUserForm = document.querySelector('[data-admin-user-form]');
      const roleAssignmentList = document.querySelector('[data-role-assignment-list]');
      const loginPolicyForm = document.querySelector('[data-login-policy]');
      const geminiForm = document.querySelector('[data-gemini-form]');
      const geminiResetButton = geminiForm ? geminiForm.querySelector('[data-action="reset-gemini"]') : null;
      const geminiTestButton = geminiForm ? geminiForm.querySelector('[data-action="test-gemini"]') : null;

      const BASE_SEARCH_INDEX = [
        { category: 'Workspace', title: 'Operational overview', description: 'Monitor KPIs for customers, tickets, and subsidy.', link: '#overview' },
        { category: 'Onboarding', title: 'Create user account', description: 'Admin-created logins for employees, installers, referrers, and customers.', link: '#onboarding' },
        { category: 'Onboarding', title: 'Pending employee invitations', description: 'Approve or reject invites submitted internally.', link: '#onboarding' },
        { category: 'Access Control', title: 'Authentication controls', description: 'Lockout rules, retry limits, and MFA enforcement.', link: '#access' },
        { category: 'System Health', title: 'Health summary & monitoring', description: 'Check uptime, backup status, and export logs.', link: '#health' },
        { category: 'AI Integrations', title: 'Gemini API configuration', description: 'Update API key and model codes for copilots.', link: '#ai' },
        { category: 'Complaints', title: 'Complaint lifecycle', description: 'Track intake, triage, work, and resolution phases.', link: '#complaints' },
        { category: 'Audit', title: 'Data governance queue', description: 'Review deletion and export requests.', link: '#audit' },
      ];

      let searchIndex = [...BASE_SEARCH_INDEX];
      let storageEnabled = true;

      try {
        const testKey = '__dashboard_test__';
        localStorage.setItem(testKey, '1');
        localStorage.removeItem(testKey);
      } catch (error) {
        storageEnabled = false;
        console.warn('Local storage unavailable; data will not persist between sessions.', error);
      }

      function announceToast(title, message, type = 'info', options = {}) {
        if (!toastTemplate || !toastContainer) return;
        const toastNode = toastTemplate.content.firstElementChild.cloneNode(true);
        toastNode.classList.add(`dashboard-toast--${type}`);
        toastNode.querySelector('.dashboard-toast-title').textContent = title;
        toastNode.querySelector('.dashboard-toast-message').textContent = message;
        toastContainer.appendChild(toastNode);
        requestAnimationFrame(() => toastNode.dataset.state = 'visible');
        const timeout = options.autoDismiss === false ? null : window.setTimeout(() => dismissToast(toastNode), options.duration || 4200);
        if (timeout) {
          toastNode.dataset.timeoutId = timeout;
        }
        toastNode.addEventListener('click', () => dismissToast(toastNode));
      }

      function dismissToast(toastNode) {
        if (!toastNode || toastNode.dataset.state === 'leaving') return;
        toastNode.dataset.state = 'leaving';
        const timeoutId = toastNode.dataset.timeoutId;
        if (timeoutId) {
          clearTimeout(Number(timeoutId));
        }
        setTimeout(() => toastNode.remove(), 200);
      }

      function prefersDark() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      function applyTheme(mode, options = {}) {
        const resolved = mode === 'auto' ? (prefersDark() ? 'dark' : 'light') : mode;
        document.body.dataset.dashboardTheme = resolved;
        document.body.dataset.dashboardThemeMode = mode;
        themeOptions.forEach((input) => {
          input.checked = input.value === mode;
        });
        if (storageEnabled) {
          localStorage.setItem(THEME_STORAGE_KEY, mode);
        }
        if (!options.silent) {
          announceToast('Theme updated', `Admin theme switched to ${resolved} mode.`, 'info', { autoDismiss: true });
        }
      }

      function initTheme() {
        let initialMode = 'light';
        if (storageEnabled) {
          const stored = localStorage.getItem(THEME_STORAGE_KEY);
          if (stored) {
            initialMode = stored;
          }
        }
        applyTheme(initialMode, { silent: true });
        if (initialMode === 'auto' && window.matchMedia) {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            applyTheme('auto', { silent: true });
          });
        }
      }

      themeOptions.forEach((input) => {
        input.addEventListener('change', () => applyTheme(input.value));
      });

      initTheme();

      function activateTab(id) {
        tabPanels.forEach((panel) => {
          const matches = panel.id === id;
          panel.hidden = !matches;
          panel.setAttribute('aria-hidden', String(!matches));
        });
        navButtons.forEach((button) => {
          const active = button.dataset.tabTarget === id;
          button.setAttribute('aria-selected', String(active));
          button.classList.toggle('dashboard-nav-link--active', active);
        });
        if (id) {
          history.replaceState(null, '', `#${id}`);
        }
      }

      navButtons.forEach((button) => {
        button.addEventListener('click', () => activateTab(button.dataset.tabTarget));
      });

      const initialHash = window.location.hash.replace('#', '');
      if (initialHash && tabPanels.some((panel) => panel.id === initialHash)) {
        activateTab(initialHash);
      } else {
        activateTab(tabPanels[0].id);
      }

      quickSearchButton?.addEventListener('click', () => {
        activateTab('overview');
        searchInput?.focus();
      });

      function loadFromStorage(key, fallback) {
        if (!storageEnabled) return fallback;
        try {
          const value = localStorage.getItem(key);
          return value ? JSON.parse(value) : fallback;
        } catch (error) {
          console.warn('Failed to load state for', key, error);
          return fallback;
        }
      }

      function saveToStorage(key, value) {
        if (!storageEnabled) return;
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (error) {
          console.warn('Failed to persist state for', key, error);
        }
      }

      const defaultUsers = [
        {
          id: 'user-system-admin',
          name: 'System Administrator',
          email: 'admin@dakshayani.in',
          role: 'Admin',
          username: 'sysadmin',
          passwordHash: null,
          passwordSetAt: new Date().toISOString(),
          status: 'Active',
          createdAt: new Date().toISOString(),
          permissions: 'Full access',
        },
      ];

      const state = {
        users: loadFromStorage(USER_STORAGE_KEY, defaultUsers),
        pendingInvites: loadFromStorage(PENDING_STORAGE_KEY, []),
      };

      function persistState() {
        saveToStorage(USER_STORAGE_KEY, state.users);
        saveToStorage(PENDING_STORAGE_KEY, state.pendingInvites);
      }

      function formatDate(dateString) {
        if (!dateString) return '--';
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) return '--';
        return date.toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
      }

      function maskPassword(hash) {
        return hash ? '••••••••' : '--';
      }

      function updateUserCount() {
        if (!userCountLabel) return;
        const total = state.users.length;
        userCountLabel.textContent = `${total} user${total === 1 ? '' : 's'}`;
      }

      function renderUsers() {
        if (!userTableBody) return;
        const filter = userFilterSelect?.value || 'all';
        const filtered = state.users.filter((user) => filter === 'all' || user.role === filter);

        userTableBody.innerHTML = '';

        if (!filtered.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'dashboard-empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = filter === 'all' ? 'No users created yet.' : `No users found for role ${filter}.`;
          emptyRow.appendChild(cell);
          userTableBody.appendChild(emptyRow);
        } else {
          filtered.forEach((user) => {
            const row = document.createElement('tr');
            row.dataset.userId = user.id;
            row.innerHTML = `
              <td>
                <div class="dashboard-user">
                  <strong>${user.name}</strong>
                  <span>${user.email || ''}</span>
                </div>
              </td>
              <td><span class="dashboard-chip">${user.role}</span></td>
              <td>${user.username || '--'}</td>
              <td>
                <span class="dashboard-status dashboard-status--${user.status === 'Active' ? 'active' : 'inactive'}">${user.status}</span>
              </td>
              <td>
                <div class="dashboard-credentials">
                  <span class="dashboard-credentials-username">${user.username || '--'}</span>
                  <span class="dashboard-credentials-password">${maskPassword(user.passwordHash)}</span>
                  <small>Last set: ${formatDate(user.passwordSetAt)}</small>
                </div>
              </td>
              <td>
                <div class="dashboard-inline-actions">
                  <button type="button" class="btn btn-ghost btn-icon" data-action="toggle-status">${
                    user.status === 'Active' ? '<i class="fa-solid fa-user-slash"></i>' : '<i class="fa-solid fa-user-check"></i>'
                  }<span class="sr-only">Toggle status</span></button>
                  <button type="button" class="btn btn-ghost btn-icon" data-action="reset-password"><i class="fa-solid fa-key"></i><span class="sr-only">Reset password</span></button>
                </div>
              </td>
            `;
            userTableBody.appendChild(row);
          });
        }

        updateUserCount();
        renderRoleAssignments();
        updateMetrics();
        refreshSearchIndex();
      }

      function renderRoleAssignments() {
        if (!roleAssignmentList) return;
        roleAssignmentList.innerHTML = '';
        if (!state.users.length) {
          const li = document.createElement('li');
          li.className = 'dashboard-list-empty';
          li.innerHTML = `
            <p class="primary">No active users recorded.</p>
            <p class="secondary">Create users or approve invitations to populate this summary.</p>
          `;
          roleAssignmentList.appendChild(li);
          return;
        }

        const assignments = state.users.reduce((map, user) => {
          if (!map[user.role]) map[user.role] = { total: 0, active: 0 };
          map[user.role].total += 1;
          if (user.status === 'Active') map[user.role].active += 1;
          return map;
        }, {});

        Object.entries(assignments).forEach(([role, counts]) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <p class="primary">${role}</p>
            <p class="secondary">${counts.active} active of ${counts.total} total accounts.</p>
          `;
          roleAssignmentList.appendChild(li);
        });
      }

      function renderPendingInvites() {
        if (!pendingList) return;
        pendingList.innerHTML = '';

        if (!state.pendingInvites.length) {
          const empty = document.createElement('li');
          empty.className = 'dashboard-list-empty';
          empty.innerHTML = `
            <p class="primary">No pending invitations logged.</p>
            <p class="secondary">Employee-submitted profiles will appear here for your approval.</p>
          `;
          pendingList.appendChild(empty);
        } else {
          state.pendingInvites.forEach((invite) => {
            const li = document.createElement('li');
            li.dataset.inviteId = invite.id;
            li.innerHTML = `
              <p class="primary">${invite.name} · ${invite.role}</p>
              <p class="secondary">${invite.email} • Submitted by ${invite.submittedBy} on ${formatDate(invite.submittedAt)}</p>
              <div class="dashboard-inline-actions">
                <button type="button" class="btn btn-secondary btn-sm" data-approve-invite>Approve &amp; create login</button>
                <button type="button" class="btn btn-ghost btn-sm" data-reject-invite>Reject</button>
              </div>
            `;
            pendingList.appendChild(li);
          });
        }

        updateMetrics();
        refreshSearchIndex();
      }

      function updateMetrics() {
        if (metrics.approvals) {
          metrics.approvals.textContent = String(state.pendingInvites.length);
        }
        if (metrics.customers) {
          const customerCount = state.users.filter((user) => user.role === 'Customer' && user.status === 'Active').length;
          metrics.customers.textContent = String(customerCount);
        }
      }

      function refreshSearchIndex() {
        searchIndex = [...BASE_SEARCH_INDEX];
        state.users.slice(0, 8).forEach((user) => {
          searchIndex.push({
            category: 'Users',
            title: `${user.name} (${user.role})`,
            description: `Username: ${user.username || 'Not set'} · Status: ${user.status}`,
            link: '#onboarding',
          });
        });
        state.pendingInvites.slice(0, 8).forEach((invite) => {
          searchIndex.push({
            category: 'Approvals',
            title: `Pending: ${invite.name}`,
            description: `${invite.role} invite submitted by ${invite.submittedBy}.`,
            link: '#onboarding',
          });
        });
      }

      function handleSearch(query) {
        if (!searchResultsHost) return;
        const trimmed = query.trim().toLowerCase();
        searchResultsHost.innerHTML = '';

        if (!trimmed) {
          searchResultsHost.innerHTML = '<p class="dashboard-search-empty">Start typing to surface admin modules, records, and recent activity.</p>';
          searchResultsHost.hidden = false;
          return;
        }

        const matches = searchIndex.filter((entry) =>
          entry.title.toLowerCase().includes(trimmed) ||
          entry.description.toLowerCase().includes(trimmed) ||
          entry.category.toLowerCase().includes(trimmed)
        );

        if (!matches.length) {
          searchResultsHost.innerHTML = '<p class="dashboard-search-empty">No matches yet. Try "installer" or "AMC".</p>';
          searchResultsHost.hidden = false;
          return;
        }

        const grouped = matches.reduce((map, entry) => {
          if (!map[entry.category]) map[entry.category] = [];
          map[entry.category].push(entry);
          return map;
        }, {});

        Object.entries(grouped).forEach(([category, items]) => {
          const resultNode = searchResultTemplate.content.firstElementChild.cloneNode(true);
          resultNode.querySelector('h3').textContent = category;
          const list = resultNode.querySelector('ul');
          items.forEach((item) => {
            const itemNode = searchItemTemplate.content.firstElementChild.cloneNode(true);
            itemNode.querySelector('.title').textContent = item.title;
            itemNode.querySelector('.desc').textContent = item.description;
            itemNode.addEventListener('click', () => {
              activateTab(item.link.replace('#', ''));
            });
            list.appendChild(itemNode);
          });
          searchResultsHost.appendChild(resultNode);
        });

        searchResultsHost.hidden = false;
      }

      searchInput?.addEventListener('input', (event) => handleSearch(event.target.value));
      searchForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        const firstLink = searchResultsHost?.querySelector('li');
        if (firstLink) {
          firstLink.click();
        }
      });

      userFilterSelect?.addEventListener('change', renderUsers);

      createUserForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const fullName = formData.get('fullName').trim();
        const email = formData.get('email').trim();
        const username = formData.get('username').trim();
        const password = formData.get('password').trim();
        const role = formData.get('role');
        const permissions = formData.get('permissions').trim();

        if (!fullName || !email || !username || !password) {
          announceToast('Missing information', 'Please provide full name, email, username, and password.', 'error');
          return;
        }

        if (state.users.some((user) => user.username === username)) {
          announceToast('Duplicate username', 'That username is already in use. Choose another.', 'error');
          return;
        }

        const now = new Date().toISOString();
        const newUser = {
          id: `user-${Date.now()}`,
          name: fullName,
          email,
          role,
          username,
          passwordHash: btoa(password),
          passwordSetAt: now,
          status: 'Active',
          createdAt: now,
          permissions: permissions || 'Standard access',
        };

        state.users.push(newUser);
        persistState();
        renderUsers();
        announceToast('User created', `${fullName} is active with username ${username}.`, 'success');
        form.reset();
      });

      inviteForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const name = formData.get('name').trim();
        const email = formData.get('email').trim();
        const role = formData.get('role');
        const submittedBy = formData.get('submittedBy').trim();

        if (!name || !email || !submittedBy) {
          announceToast('Missing details', 'Provide name, email, and submitting employee.', 'error');
          return;
        }

        const invite = {
          id: `invite-${Date.now()}`,
          name,
          email,
          role,
          submittedBy,
          submittedAt: new Date().toISOString(),
        };

        state.pendingInvites.push(invite);
        persistState();
        renderPendingInvites();
        announceToast('Invitation logged', `${name} (${role}) is awaiting approval.`, 'info');
        form.reset();
      });

      pendingList?.addEventListener('click', (event) => {
        const target = event.target.closest('button');
        if (!target) return;
        const listItem = target.closest('li[data-invite-id]');
        if (!listItem) return;
        const inviteId = listItem.dataset.inviteId;
        const invite = state.pendingInvites.find((entry) => entry.id === inviteId);
        if (!invite) return;

        if (target.hasAttribute('data-approve-invite')) {
          let username = prompt(`Enter username for ${invite.name}:`);
          if (!username) {
            announceToast('Approval cancelled', 'Username is required to activate the account.', 'warning');
            return;
          }
          username = username.trim();
          if (!username) {
            announceToast('Approval cancelled', 'Username is required to activate the account.', 'warning');
            return;
          }
          if (state.users.some((user) => user.username === username)) {
            announceToast('Duplicate username', 'That username is already in use. Choose another.', 'error');
            return;
          }
          let password = prompt(`Set initial password for ${invite.name}:`);
          if (!password) {
            announceToast('Approval cancelled', 'Password is required to activate the account.', 'warning');
            return;
          }
          password = password.trim();
          if (password.length < 6) {
            announceToast('Weak password', 'Please choose a password with at least 6 characters.', 'error');
            return;
          }
          const now = new Date().toISOString();
          state.users.push({
            id: `user-${Date.now()}`,
            name: invite.name,
            email: invite.email,
            role: invite.role,
            username,
            passwordHash: btoa(password),
            passwordSetAt: now,
            status: 'Active',
            createdAt: now,
            permissions: 'Role default',
          });
          state.pendingInvites = state.pendingInvites.filter((entry) => entry.id !== inviteId);
          persistState();
          renderUsers();
          renderPendingInvites();
          announceToast('User activated', `${invite.name} is now active with username ${username}.`, 'success');
        } else if (target.hasAttribute('data-reject-invite')) {
          state.pendingInvites = state.pendingInvites.filter((entry) => entry.id !== inviteId);
          persistState();
          renderPendingInvites();
          announceToast('Invitation rejected', `${invite.name}'s invitation has been removed.`, 'info');
        }
      });

      userTableBody?.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const row = button.closest('tr[data-user-id]');
        if (!row) return;
        const userId = row.dataset.userId;
        const user = state.users.find((entry) => entry.id === userId);
        if (!user) return;

        if (button.dataset.action === 'toggle-status') {
          user.status = user.status === 'Active' ? 'Inactive' : 'Active';
          persistState();
          renderUsers();
          announceToast('Status updated', `${user.name} is now ${user.status}.`, 'info');
        } else if (button.dataset.action === 'reset-password') {
          let password = prompt(`Enter a new password for ${user.name}:`);
          if (!password) {
            announceToast('Reset cancelled', 'Password reset aborted.', 'warning');
            return;
          }
          password = password.trim();
          if (password.length < 6) {
            announceToast('Weak password', 'Please choose a password with at least 6 characters.', 'error');
            return;
          }
          user.passwordHash = btoa(password);
          user.passwordSetAt = new Date().toISOString();
          persistState();
          renderUsers();
          announceToast('Password updated', `${user.name}'s credentials have been refreshed.`, 'success');
        }
      });

      loginPolicyForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        announceToast('Policies saved', 'Login and session controls updated successfully.', 'success');
      });

      const geminiDefaultState = {
        apiKey: DEFAULT_GEMINI_KEY,
        textModel: 'gemini-2.5-flash',
        imageModel: 'gemini-2.5-flash-image',
        ttsModel: 'gemini-2.5-flash-preview-tts',
      };

      function loadGeminiSettings() {
        if (!geminiForm) return;
        const stored = loadFromStorage(GEMINI_STORAGE_KEY, geminiDefaultState);
        geminiForm.apiKey.value = stored.apiKey || DEFAULT_GEMINI_KEY;
        geminiForm.textModel.value = stored.textModel || 'gemini-2.5-flash';
        geminiForm.imageModel.value = stored.imageModel || 'gemini-2.5-flash-image';
        geminiForm.ttsModel.value = stored.ttsModel || 'gemini-2.5-flash-preview-tts';
      }

      function saveGeminiSettings() {
        if (!geminiForm) return;
        const payload = {
          apiKey: geminiForm.apiKey.value.trim(),
          textModel: geminiForm.textModel.value.trim(),
          imageModel: geminiForm.imageModel.value.trim(),
          ttsModel: geminiForm.ttsModel.value.trim(),
        };
        saveToStorage(GEMINI_STORAGE_KEY, payload);
      }

      geminiForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        saveGeminiSettings();
        announceToast('Gemini settings saved', 'API credentials and model codes stored securely.', 'success');
      });

      geminiResetButton?.addEventListener('click', () => {
        if (!geminiForm) return;
        geminiForm.apiKey.value = DEFAULT_GEMINI_KEY;
        geminiForm.textModel.value = 'gemini-2.5-flash';
        geminiForm.imageModel.value = 'gemini-2.5-flash-image';
        geminiForm.ttsModel.value = 'gemini-2.5-flash-preview-tts';
        saveGeminiSettings();
        announceToast('Defaults restored', 'Gemini configuration has been reset to defaults.', 'info');
      });

      geminiTestButton?.addEventListener('click', async () => {
        if (!geminiForm || !geminiTestButton) return;
        const button = geminiTestButton;
        const apiKey = geminiForm.apiKey.value.trim();
        if (!apiKey) {
          announceToast('Missing API key', 'Enter a Gemini API key before testing the connection.', 'error');
          return;
        }

        button.disabled = true;
        button.dataset.loading = 'true';
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Testing…';

        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${encodeURIComponent(apiKey)}`);
          if (!response.ok) {
            const message = `Gemini responded with status ${response.status}.`;
            announceToast('Connection failed', message, 'error');
          } else {
            const payload = await response.json();
            if (payload && Array.isArray(payload.models)) {
              announceToast('Gemini connection verified', 'API key is valid and models are reachable.', 'success');
            } else {
              announceToast('Gemini reachable', 'Received response but models list was unexpected. Verify usage limits.', 'warning');
            }
          }
        } catch (error) {
          console.error('Gemini test error', error);
          announceToast('Test error', 'Unable to reach Gemini services. Check network or API key.', 'error');
        } finally {
          button.disabled = false;
          button.dataset.loading = 'false';
          button.innerHTML = '<i class="fa-solid fa-plug-circle-check" aria-hidden="true"></i> Test connection';
        }
      });

      loadGeminiSettings();
      renderUsers();
      renderPendingInvites();
    })();
  </script>
</body>
</html>
