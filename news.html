<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Newsroom | Dakshayani Enterprises</title>
    <meta name="description" content="Daily solar and renewable energy headlines curated by Dakshayani Enterprises' Gemini automation." />

    <link rel="icon" href="images/favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .news-hero {
            background: linear-gradient(135deg, var(--base-900), var(--base-700));
            color: var(--surface);
            text-align: center;
            padding: 4rem 1.5rem;
        }
        .news-hero .subtitle {
            max-width: 780px;
            margin: 0.75rem auto 0 auto;
            color: rgba(255,255,255,0.85);
            font-size: 1.05rem;
        }
        .news-layout {
            display: grid;
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            .news-layout {
                grid-template-columns: 2fr 1fr;
            }
        }
        .news-card {
            background: var(--surface);
            border-radius: 1rem;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
            border: 1px solid var(--base-200);
            padding: 1.75rem;
        }
        .news-card h2 {
            margin-top: 0;
            font-size: 1.75rem;
            color: var(--base-900);
        }
        .digest-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--base-600);
            margin-bottom: 1.5rem;
        }
        .digest-meta span {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }
        .digest-items {
            display: grid;
            gap: 1.5rem;
        }
        .digest-item {
            border-left: 4px solid var(--primary-main);
            padding-left: 1rem;
        }
        .digest-item h3 {
            margin: 0 0 0.35rem 0;
            font-size: 1.2rem;
            color: var(--base-900);
        }
        .digest-item p {
            margin: 0.4rem 0;
            color: var(--base-600);
        }
        .digest-sources {
            list-style: none;
            padding: 0;
            margin: 0.6rem 0 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .digest-sources li a {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            background: var(--base-100);
            color: var(--primary-dark);
            font-size: 0.85rem;
        }
        .digest-sources li span {
            font-size: 0.85rem;
            color: var(--base-500);
        }
        .history-card {
            border-left: 3px solid var(--base-300);
            margin-bottom: 1rem;
            padding-left: 1rem;
        }
        .history-card h4 {
            margin: 0;
            color: var(--base-900);
            font-size: 1.05rem;
        }
        .history-card time {
            font-size: 0.85rem;
            color: var(--base-500);
        }
        .history-card ul {
            margin: 0.5rem 0 0 1rem;
            color: var(--base-600);
            font-size: 0.9rem;
        }
        .status-banner {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background: var(--primary-bg);
            border: 1px solid var(--primary-light);
            font-size: 0.95rem;
            color: var(--primary-dark);
        }
        .status-banner.error {
            background: rgba(239,68,68,0.08);
            border-color: rgba(239,68,68,0.35);
            color: #b91c1c;
        }
        .model-note {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
        }
    </style>
</head>
<body>
    <header class="site-header"></header>

    <main>
        <section class="news-hero">
            <div class="container" style="max-width: 960px;">
                <h1 class="title" style="color: var(--surface);">Newsroom</h1>
                <p class="subtitle">Stay ahead with the solar and renewable headlines that matter for India and global markets. Dakshayani Enterprises publishes a fresh digest every morning using Gemini automations.</p>
                <p class="model-note" id="news-model-note" hidden></p>
            </div>
        </section>

        <section class="section">
            <div class="container news-layout" style="max-width: 1200px;">
                <article class="news-card" id="news-latest">
                    <div class="status-banner" id="news-status"><i class="fa-solid fa-spinner fa-spin"></i> Loading the latest digest…</div>
                </article>
                <aside class="news-card" id="news-history">
                    <h2 style="margin-top: 0; font-size: 1.4rem;">Recent Digests</h2>
                    <p style="color: var(--base-600); font-size: 0.95rem;">Catch up on earlier briefings generated this week. Each digest blends India-focused policy and market moves with global developments.</p>
                    <div id="news-history-list"></div>
                </aside>
            </div>
        </section>
    </main>

    <footer class="site-footer"></footer>

    <script>
        const latestContainer = document.getElementById('news-latest');
        const statusBanner = document.getElementById('news-status');
        const historyContainer = document.getElementById('news-history-list');
        const modelNote = document.getElementById('news-model-note');

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatTimestamp(epoch, fallback) {
            if (typeof epoch === 'number' && epoch > 0) {
                try {
                    return new Date(epoch * 1000).toLocaleString('en-IN', {
                        timeZone: 'Asia/Kolkata',
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                } catch (error) {
                    // fall through
                }
            }

            if (fallback) {
                return escapeHtml(fallback);
            }

            return '—';
        }

        function renderLatestDigest(digest) {
            if (!digest || !Array.isArray(digest.items) || digest.items.length === 0) {
                latestContainer.innerHTML = `
                    <div class="status-banner error">
                        <i class="fa-solid fa-circle-info"></i>
                        No AI digest is available yet. Please check back after the next automation run at 6:00 AM IST.
                    </div>
                `;
                return;
            }

            const generatedLabel = formatTimestamp(digest.generatedAtEpoch, digest.generatedAtLabel || digest.generatedAt);
            const timezoneLabel = escapeHtml(digest.timezone || 'Asia/Kolkata');
            const summary = digest.summary ? `<p style="color: var(--base-700); font-size: 1.05rem;">${escapeHtml(digest.summary)}</p>` : '';

            const itemsHtml = digest.items.map((item) => {
                const action = item.recommendedAction ? `<p><strong>Action:</strong> ${escapeHtml(item.recommendedAction)}</p>` : '';
                let sources = '';
                if (Array.isArray(item.sourceHints) && item.sourceHints.length > 0) {
                    const hints = item.sourceHints.map((hint) => {
                        const label = escapeHtml(hint.label || 'Source');
                        const url = typeof hint.url === 'string' && hint.url.trim() !== '' ? hint.url.trim() : '';
                        if (url) {
                            return `<li><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${label} <i class="fa-solid fa-arrow-up-right-from-square"></i></a></li>`;
                        }
                        return `<li><span><i class="fa-solid fa-link"></i> ${label}</span></li>`;
                    }).join('');
                    sources = `<ul class="digest-sources">${hints}</ul>`;
                }

                return `
                    <div class="digest-item">
                        <h3>${escapeHtml(item.headline)}</h3>
                        <p style="font-size: 0.9rem; color: var(--base-500);"><i class="fa-solid fa-location-dot"></i> ${escapeHtml(item.region || 'Global')}</p>
                        <p>${escapeHtml(item.summary || '')}</p>
                        ${action}
                        ${sources}
                    </div>
                `;
            }).join('');

            latestContainer.innerHTML = `
                <h2>Latest Briefing</h2>
                <div class="digest-meta">
                    <span><i class="fa-solid fa-clock"></i> ${generatedLabel} (${timezoneLabel})</span>
                    <span><i class="fa-solid fa-newspaper"></i> ${digest.items.length} curated stories</span>
                </div>
                ${summary}
                <div class="digest-items">${itemsHtml}</div>
            `;
        }

        function renderHistory(history) {
            if (!Array.isArray(history) || history.length === 0) {
                historyContainer.innerHTML = '<p style="color: var(--base-500);">No previous digests yet. As new reports are generated they will appear here.</p>';
                return;
            }

            const cards = history.map((entry) => {
                const generatedLabel = formatTimestamp(entry.generatedAtEpoch, entry.generatedAtLabel || entry.generatedAt);
                const bullets = Array.isArray(entry.items)
                    ? entry.items.slice(0, 3).map((item) => `<li>${escapeHtml(item.headline || '')}</li>`).join('')
                    : '';

                return `
                    <div class="history-card">
                        <h4>${escapeHtml(entry.summary || 'Digest update')}</h4>
                        <time>${generatedLabel}</time>
                        ${bullets ? `<ul>${bullets}</ul>` : ''}
                    </div>
                `;
            }).join('');

            historyContainer.innerHTML = cards;
        }

        function loadDigest() {
            fetch('api/public/ai/news', { cache: 'no-store' })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to load newsroom feed.');
                    }
                    return response.json();
                })
                .then((payload) => {
                    if (statusBanner) {
                        statusBanner.remove();
                    }
                    renderLatestDigest(payload.latest || null);
                    renderHistory(payload.history || []);
                })
                .catch((error) => {
                    console.error('Newsroom feed error:', error);
                    if (statusBanner) {
                        statusBanner.classList.add('error');
                        statusBanner.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Unable to load the Gemini digest right now. Please refresh in a moment.';
                    }
                    renderHistory([]);
                });
        }

        if (window.dakshayaniAIConfig && typeof window.dakshayaniAIConfig.getConfig === 'function') {
            window.dakshayaniAIConfig.getConfig().then((config) => {
                const model = config && config.models && typeof config.models.text === 'string' ? config.models.text.trim() : '';
                if (model && modelNote) {
                    modelNote.textContent = `Powered by Google Gemini (${model})`; 
                    modelNote.hidden = false;
                }
            }).catch(() => {
                // Silently ignore configuration errors on the public page.
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadDigest);
        } else {
            loadDigest();
        }
    </script>
    <script src="script.js" defer></script>
</body>
</html>
